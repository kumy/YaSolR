// SPDX-License-Identifier: MIT
/*
 * Copyright (C) 2023-2024 Mathieu Carbou and others
 */
#pragma once

#include "MycilaDimmer.h"
#include <Arduino.h>

#define MYCILA_DIMMER_LUT_MAX_LEVEL 255

namespace Mycila {
  namespace DimmerInternal {
    static const uint16_t delay50HzLUT[] PROGMEM = {10000, 9837, 9695, 9557, 9425, 9297, 9173, 9054, 8939, 8827, 8720, 8617, 8517, 8421, 8329, 8240, 8154, 8071, 7992, 7915, 7841, 7770, 7702, 7636, 7573, 7512, 7454, 7397, 7343, 7291, 7241, 7193, 7147, 7102, 7060, 7018, 6979, 6941, 6904, 6869, 6834, 6802, 6770, 6739, 6710, 6681, 6654, 6627, 6601, 6576, 6552, 6529, 6506, 6484, 6462, 6441, 6420, 6400, 6380, 6361, 6342, 6323, 6305, 6287, 6269, 6251, 6234, 6216, 6199, 6182, 6165, 6148, 6131, 6114, 6097, 6080, 6063, 6046, 6029, 6012, 5995, 5977, 5960, 5942, 5925, 5907, 5889, 5870, 5852, 5834, 5815, 5796, 5777, 5758, 5738, 5719, 5699, 5679, 5659, 5639, 5618, 5597, 5576, 5555, 5534, 5513, 5491, 5469, 5447, 5425, 5403, 5381, 5358, 5336, 5313, 5290, 5267, 5244, 5221, 5198, 5175, 5151, 5128, 5104, 5081, 5057, 5034, 5010, 4987, 4963, 4940, 4916, 4893, 4869, 4846, 4822, 4799, 4776, 4753, 4730, 4707, 4684, 4661, 4638, 4616, 4594, 4571, 4549, 4527, 4506, 4484, 4463, 4441, 4420, 4399, 4379, 4358, 4338, 4318, 4298, 4278, 4258, 4239, 4219, 4200, 4181, 4163, 4144, 4126, 4108, 4090, 4072, 4054, 4036, 4019, 4001, 3984, 3967, 3950, 3933, 3916, 3899, 3882, 3865, 3848, 3831, 3814, 3796, 3779, 3762, 3744, 3726, 3709, 3690, 3672, 3653, 3634, 3615, 3595, 3575, 3554, 3533, 3511, 3489, 3466, 3442, 3418, 3393, 3367, 3341, 3313, 3284, 3255, 3224, 3193, 3160, 3126, 3090, 3053, 3015, 2975, 2934, 2891, 2847, 2800, 2752, 2702, 2650, 2596, 2540, 2481, 2420, 2357, 2291, 2223, 2152, 2078, 2001, 1921, 1839, 1753, 1664, 1571, 1475, 1375, 1272, 1165, 1053, 938, 819, 695, 567, 434, 297, 154, 0};
    static const uint16_t delay60HzLUT[] PROGMEM = {8333, 8197, 8079, 7964, 7854, 7747, 7644, 7544, 7448, 7356, 7266, 7180, 7097, 7017, 6940, 6866, 6794, 6725, 6659, 6595, 6534, 6475, 6418, 6363, 6310, 6260, 6211, 6164, 6119, 6075, 6034, 5994, 5955, 5918, 5882, 5848, 5815, 5783, 5753, 5723, 5695, 5667, 5641, 5616, 5591, 5567, 5544, 5522, 5501, 5480, 5460, 5440, 5421, 5402, 5384, 5367, 5350, 5333, 5316, 5300, 5284, 5269, 5254, 5238, 5224, 5209, 5194, 5180, 5165, 5151, 5137, 5123, 5109, 5095, 5080, 5066, 5052, 5038, 5024, 5009, 4995, 4981, 4966, 4951, 4937, 4922, 4907, 4892, 4876, 4861, 4845, 4830, 4814, 4798, 4782, 4765, 4749, 4732, 4715, 4698, 4681, 4664, 4647, 4629, 4612, 4594, 4576, 4558, 4539, 4521, 4503, 4484, 4465, 4446, 4428, 4409, 4389, 4370, 4351, 4332, 4312, 4293, 4273, 4254, 4234, 4215, 4195, 4176, 4156, 4136, 4117, 4097, 4078, 4058, 4039, 4019, 4000, 3980, 3961, 3942, 3923, 3904, 3885, 3866, 3848, 3829, 3810, 3792, 3774, 3756, 3738, 3720, 3702, 3685, 3667, 3650, 3633, 3616, 3599, 3583, 3566, 3550, 3534, 3518, 3502, 3486, 3471, 3455, 3440, 3425, 3410, 3395, 3380, 3366, 3351, 3337, 3322, 3308, 3294, 3280, 3266, 3251, 3237, 3223, 3209, 3195, 3181, 3167, 3152, 3138, 3123, 3109, 3094, 3079, 3063, 3048, 3032, 3016, 3000, 2983, 2966, 2948, 2930, 2912, 2892, 2873, 2853, 2832, 2811, 2788, 2765, 2742, 2717, 2692, 2665, 2638, 2610, 2580, 2550, 2518, 2485, 2451, 2415, 2378, 2339, 2299, 2258, 2214, 2169, 2123, 2074, 2023, 1971, 1916, 1859, 1800, 1738, 1675, 1608, 1539, 1468, 1394, 1317, 1237, 1154, 1068, 978, 886, 790, 690, 587, 481, 370, 256, 137, 0};
    static const float vrms50HzLUT[] PROGMEM = {0.000000, 0.005337, 0.013651, 0.023871, 0.035252, 0.047579, 0.060594, 0.073978, 0.087670, 0.101660, 0.115582, 0.129459, 0.143344, 0.157028, 0.170445, 0.183686, 0.196708, 0.209472, 0.221787, 0.233934, 0.245732, 0.257157, 0.268189, 0.278973, 0.289331, 0.299415, 0.309049, 0.318556, 0.327596, 0.336326, 0.344743, 0.352841, 0.360616, 0.368233, 0.375351, 0.382476, 0.389097, 0.395552, 0.401839, 0.407788, 0.413736, 0.419174, 0.424612, 0.429877, 0.434802, 0.439724, 0.444303, 0.448880, 0.453285, 0.457518, 0.461577, 0.465465, 0.469350, 0.473062, 0.476771, 0.480309, 0.483843, 0.487205, 0.490564, 0.493753, 0.496937, 0.500119, 0.503130, 0.506137, 0.509141, 0.512142, 0.514973, 0.517967, 0.520792, 0.523612, 0.526430, 0.529244, 0.532054, 0.534861, 0.537664, 0.540463, 0.543258, 0.546049, 0.548836, 0.551618, 0.554397, 0.557334, 0.560104, 0.563031, 0.565792, 0.568709, 0.571622, 0.574690, 0.577591, 0.580487, 0.583537, 0.586581, 0.589618, 0.592649, 0.595833, 0.598850, 0.602018, 0.605179, 0.608331, 0.611476, 0.614769, 0.618054, 0.621329, 0.624594, 0.627851, 0.631097, 0.634488, 0.637868, 0.641237, 0.644595, 0.647942, 0.651278, 0.654753, 0.658065, 0.661514, 0.664951, 0.668375, 0.671785, 0.675182, 0.678565, 0.681935, 0.685436, 0.688777, 0.692248, 0.695560, 0.699000, 0.702282, 0.705691, 0.708943, 0.712320, 0.715541, 0.718885, 0.722075, 0.725386, 0.728544, 0.731822, 0.734947, 0.738056, 0.741148, 0.744225, 0.747285, 0.750328, 0.753355, 0.756365, 0.759229, 0.762077, 0.765037, 0.767853, 0.770653, 0.773311, 0.776080, 0.778708, 0.781446, 0.784044, 0.786627, 0.789073, 0.791627, 0.794045, 0.796450, 0.798840, 0.801217, 0.803580, 0.805812, 0.808148, 0.810354, 0.812547, 0.814613, 0.816782, 0.818824, 0.820855, 0.822874, 0.824882, 0.826878, 0.828862, 0.830726, 0.832687, 0.834529, 0.836360, 0.838181, 0.839991, 0.841790, 0.843579, 0.845358, 0.847125, 0.848882, 0.850628, 0.852364, 0.854190, 0.855903, 0.857606, 0.859397, 0.861176, 0.862845, 0.864697, 0.866440, 0.868266, 0.870078, 0.871877, 0.873756, 0.875619, 0.877560, 0.879484, 0.881481, 0.883461, 0.885510, 0.887627, 0.889722, 0.891882, 0.894102, 0.896296, 0.898631, 0.901017, 0.903372, 0.905853, 0.908297, 0.910860, 0.913456, 0.916157, 0.918882, 0.921626, 0.924456, 0.927294, 0.930202, 0.933106, 0.936128, 0.939129, 0.942165, 0.945224, 0.948296, 0.951370, 0.954486, 0.957577, 0.960632, 0.963683, 0.966670, 0.969621, 0.972519, 0.975344, 0.978079, 0.980676, 0.983181, 0.985545, 0.987777, 0.989835, 0.991727, 0.993421, 0.994923, 0.996235, 0.997328, 0.998215, 0.998905, 0.999404, 0.999732, 0.999914, 0.999988, 1.000000};
    static const float vrms60HzLUT[] PROGMEM = {0.000000, 0.005366, 0.013664, 0.023887, 0.035271, 0.047640, 0.060616, 0.074117, 0.087841, 0.101634, 0.115688, 0.129596, 0.143429, 0.157115, 0.170593, 0.183807, 0.196891, 0.209627, 0.221975, 0.234093, 0.245764, 0.257157, 0.268254, 0.279038, 0.289496, 0.299415, 0.309183, 0.318590, 0.327629, 0.336494, 0.344777, 0.352875, 0.360785, 0.368301, 0.375623, 0.382544, 0.389267, 0.395790, 0.401907, 0.408026, 0.413736, 0.419446, 0.424748, 0.429844, 0.434937, 0.439825, 0.444507, 0.448982, 0.453251, 0.457518, 0.461577, 0.465634, 0.469485, 0.473332, 0.476974, 0.480410, 0.483843, 0.487273, 0.490699, 0.493920, 0.497138, 0.500152, 0.503163, 0.506371, 0.509175, 0.512176, 0.515173, 0.517967, 0.520958, 0.523745, 0.526529, 0.529310, 0.532087, 0.534861, 0.537828, 0.540594, 0.543356, 0.546114, 0.548868, 0.551815, 0.554560, 0.557302, 0.560234, 0.563161, 0.565889, 0.568807, 0.571719, 0.574625, 0.577720, 0.580615, 0.583697, 0.586581, 0.589650, 0.592713, 0.595769, 0.599008, 0.602050, 0.605273, 0.608489, 0.611696, 0.614895, 0.618085, 0.621266, 0.624625, 0.627789, 0.631128, 0.634457, 0.637776, 0.641268, 0.644565, 0.647851, 0.651308, 0.654753, 0.658185, 0.661425, 0.664832, 0.668405, 0.671785, 0.675153, 0.678507, 0.682023, 0.685349, 0.688835, 0.692133, 0.695589, 0.698857, 0.702282, 0.705521, 0.708915, 0.712292, 0.715485, 0.718830, 0.721992, 0.725304, 0.728434, 0.731713, 0.734811, 0.738056, 0.741122, 0.744172, 0.747205, 0.750223, 0.753224, 0.756209, 0.759021, 0.761974, 0.764909, 0.767675, 0.770425, 0.773160, 0.775880, 0.778584, 0.781272, 0.783797, 0.786455, 0.788951, 0.791433, 0.793900, 0.796354, 0.798650, 0.801075, 0.803344, 0.805601, 0.807845, 0.810076, 0.812294, 0.814361, 0.816554, 0.818598, 0.820630, 0.822650, 0.824659, 0.826657, 0.828510, 0.830485, 0.832318, 0.834270, 0.836081, 0.837882, 0.839672, 0.841453, 0.843349, 0.845107, 0.846856, 0.848594, 0.850321, 0.852038, 0.853745, 0.855561, 0.857246, 0.859040, 0.860703, 0.862473, 0.864230, 0.866092, 0.867825, 0.869660, 0.871480, 0.873287, 0.875192, 0.877081, 0.879064, 0.881029, 0.882976, 0.885119, 0.887135, 0.889235, 0.891417, 0.893575, 0.895910, 0.898216, 0.900493, 0.902936, 0.905344, 0.907906, 0.910428, 0.913001, 0.915710, 0.918370, 0.921154, 0.923965, 0.926800, 0.929734, 0.932675, 0.935696, 0.938709, 0.941710, 0.944830, 0.947915, 0.950959, 0.954081, 0.957199, 0.960242, 0.963312, 0.966335, 0.969297, 0.972230, 0.975024, 0.977795, 0.980438, 0.982940, 0.985321, 0.987562, 0.989644, 0.991553, 0.993273, 0.994811, 0.996126, 0.997243, 0.998156, 0.998861, 0.999371, 0.999713, 0.999905, 0.999985, 1.000000};
  } // namespace DimmerInternal
} // namespace Mycila

uint16_t Mycila::Dimmer::_lookupFiringDelay(uint8_t level, float frequency) {
  if (level == 0)
    return 500000 / frequency; // semi-period in microseconds

  if (level >= MYCILA_DIMMER_LUT_MAX_LEVEL)
    return 0;

  return frequency == 60 ? (uint16_t)pgm_read_word(&Mycila::DimmerInternal::delay60HzLUT[level]) : (uint16_t)pgm_read_word(&Mycila::DimmerInternal::delay50HzLUT[level]);
}

float Mycila::Dimmer::_lookupVrms(uint8_t level, float frequency) {
  if (level == 0)
    return 0;

  if (level >= MYCILA_DIMMER_LUT_MAX_LEVEL)
    return 1;

  return frequency == 60 ? static_cast<float>(pgm_read_float(&Mycila::DimmerInternal::vrms60HzLUT[level])) : static_cast<float>(pgm_read_float(&Mycila::DimmerInternal::vrms50HzLUT[level]));
}
