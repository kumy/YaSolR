// SPDX-License-Identifier: MIT
/*
 * Copyright (C) 2023-2024 Mathieu Carbou and others
 */
#pragma once

#include "MycilaDimmer.h"
#include <Arduino.h>

namespace Mycila {
  namespace DimmerInternal {
    static const uint16_t delay50HzLUT[] PROGMEM = {10000, 9601, 9435, 9308, 9200, 9105, 9019, 8940, 8866, 8796, 8730, 8668, 8607, 8550, 8494, 8440, 8388, 8337, 8288, 8239, 8192, 8147, 8102, 8058, 8014, 7972, 7930, 7890, 7849, 7810, 7771, 7732, 7694, 7657, 7620, 7583, 7547, 7512, 7476, 7442, 7407, 7373, 7339, 7306, 7272, 7240, 7207, 7175, 7143, 7111, 7079, 7048, 7017, 6986, 6955, 6925, 6895, 6864, 6835, 6805, 6775, 6746, 6717, 6688, 6659, 6630, 6602, 6573, 6545, 6517, 6489, 6461, 6433, 6405, 6378, 6350, 6323, 6296, 6269, 6242, 6215, 6188, 6161, 6134, 6108, 6081, 6055, 6028, 6002, 5976, 5950, 5924, 5898, 5872, 5846, 5820, 5794, 5768, 5743, 5717, 5691, 5666, 5640, 5615, 5590, 5564, 5539, 5514, 5488, 5463, 5438, 5413, 5387, 5362, 5337, 5312, 5287, 5262, 5237, 5212, 5187, 5162, 5137, 5112, 5087, 5062, 5037, 5012, 4987, 4962, 4937, 4912, 4887, 4862, 4837, 4812, 4787, 4762, 4737, 4712, 4687, 4662, 4637, 4612, 4586, 4561, 4536, 4511, 4485, 4460, 4435, 4409, 4384, 4359, 4333, 4308, 4282, 4256, 4231, 4205, 4179, 4153, 4127, 4101, 4075, 4049, 4023, 3997, 3971, 3944, 3918, 3891, 3865, 3838, 3811, 3784, 3757, 3730, 3703, 3676, 3649, 3621, 3594, 3566, 3538, 3510, 3482, 3454, 3426, 3397, 3369, 3340, 3311, 3282, 3253, 3224, 3194, 3164, 3135, 3104, 3074, 3044, 3013, 2982, 2951, 2920, 2888, 2856, 2824, 2792, 2759, 2727, 2693, 2660, 2626, 2592, 2557, 2523, 2487, 2452, 2416, 2379, 2342, 2305, 2267, 2228, 2189, 2150, 2109, 2069, 2027, 1985, 1941, 1897, 1852, 1807, 1760, 1711, 1662, 1611, 1559, 1505, 1449, 1392, 1331, 1269, 1203, 1133, 1059, 980, 894, 799, 691, 564, 398, 0};
    static const uint16_t delay60HzLUT[] PROGMEM = {8333, 8000, 7862, 7756, 7667, 7588, 7516, 7450, 7388, 7330, 7275, 7223, 7173, 7125, 7078, 7033, 6990, 6947, 6906, 6866, 6827, 6789, 6751, 6715, 6679, 6643, 6609, 6575, 6541, 6508, 6475, 6443, 6412, 6381, 6350, 6319, 6289, 6260, 6230, 6201, 6172, 6144, 6116, 6088, 6060, 6033, 6006, 5979, 5952, 5926, 5899, 5873, 5847, 5821, 5796, 5771, 5745, 5720, 5695, 5671, 5646, 5622, 5597, 5573, 5549, 5525, 5501, 5478, 5454, 5431, 5407, 5384, 5361, 5338, 5315, 5292, 5269, 5246, 5224, 5201, 5179, 5156, 5134, 5112, 5090, 5068, 5046, 5024, 5002, 4980, 4958, 4936, 4915, 4893, 4871, 4850, 4828, 4807, 4786, 4764, 4743, 4722, 4700, 4679, 4658, 4637, 4616, 4595, 4573, 4552, 4531, 4510, 4489, 4468, 4448, 4427, 4406, 4385, 4364, 4343, 4322, 4301, 4281, 4260, 4239, 4218, 4197, 4177, 4156, 4135, 4114, 4093, 4073, 4052, 4031, 4010, 3989, 3968, 3947, 3927, 3906, 3885, 3864, 3843, 3822, 3801, 3780, 3759, 3738, 3717, 3696, 3674, 3653, 3632, 3611, 3590, 3568, 3547, 3525, 3504, 3482, 3461, 3439, 3418, 3396, 3374, 3352, 3331, 3309, 3287, 3265, 3243, 3220, 3198, 3176, 3154, 3131, 3109, 3086, 3063, 3040, 3018, 2995, 2972, 2948, 2925, 2902, 2878, 2855, 2831, 2807, 2783, 2759, 2735, 2711, 2686, 2662, 2637, 2612, 2587, 2562, 2536, 2511, 2485, 2459, 2433, 2407, 2380, 2354, 2327, 2299, 2272, 2244, 2217, 2188, 2160, 2131, 2102, 2073, 2043, 2013, 1983, 1952, 1921, 1889, 1857, 1824, 1791, 1758, 1724, 1689, 1654, 1618, 1581, 1544, 1505, 1466, 1426, 1385, 1343, 1299, 1254, 1208, 1160, 1109, 1057, 1002, 944, 883, 817, 745, 666, 576, 470, 332, 0};
    static const float vrms50HzLUT[] PROGMEM = {0.000000, 0.020406, 0.034299, 0.046461, 0.057615, 0.068071, 0.077999, 0.087506, 0.096666, 0.105530, 0.114138, 0.122522, 0.130705, 0.138707, 0.146546, 0.154234, 0.161784, 0.169206, 0.176508, 0.183699, 0.190786, 0.197773, 0.204668, 0.211474, 0.218197, 0.224839, 0.231405, 0.237899, 0.244322, 0.250678, 0.256970, 0.263200, 0.269370, 0.275482, 0.281538, 0.287540, 0.293489, 0.299388, 0.305238, 0.311039, 0.316794, 0.322503, 0.328169, 0.333791, 0.339371, 0.344910, 0.350408, 0.355868, 0.361289, 0.366673, 0.372020, 0.377331, 0.382606, 0.387847, 0.393054, 0.398227, 0.403368, 0.408477, 0.413553, 0.418599, 0.423614, 0.428599, 0.433554, 0.438480, 0.443377, 0.448245, 0.453086, 0.457899, 0.462685, 0.467443, 0.472176, 0.476882, 0.481562, 0.486217, 0.490846, 0.495450, 0.500030, 0.504585, 0.509116, 0.513623, 0.518107, 0.522567, 0.527004, 0.531417, 0.535809, 0.540177, 0.544524, 0.548848, 0.553150, 0.557430, 0.561689, 0.565927, 0.570143, 0.574338, 0.578512, 0.582666, 0.586799, 0.590911, 0.595003, 0.599075, 0.603127, 0.607159, 0.611171, 0.615164, 0.619137, 0.623090, 0.627024, 0.630939, 0.634835, 0.638712, 0.642570, 0.646409, 0.650229, 0.654031, 0.657814, 0.661579, 0.665325, 0.669053, 0.672763, 0.676454, 0.680128, 0.683783, 0.687420, 0.691040, 0.694641, 0.698225, 0.701791, 0.705339, 0.708870, 0.712383, 0.715878, 0.719356, 0.722817, 0.726260, 0.729686, 0.733094, 0.736485, 0.739858, 0.743215, 0.746554, 0.749876, 0.753180, 0.756468, 0.759738, 0.762991, 0.766227, 0.769446, 0.772648, 0.775832, 0.779000, 0.782150, 0.785283, 0.788400, 0.791499, 0.794581, 0.797645, 0.800693, 0.803723, 0.806737, 0.809733, 0.812712, 0.815674, 0.818618, 0.821546, 0.824456, 0.827348, 0.830224, 0.833082, 0.835922, 0.838746, 0.841551, 0.844339, 0.847110, 0.849863, 0.852598, 0.855316, 0.858016, 0.860698, 0.863362, 0.866008, 0.868636, 0.871246, 0.873838, 0.876412, 0.878967, 0.881504, 0.884023, 0.886523, 0.889004, 0.891467, 0.893911, 0.896335, 0.898741, 0.901128, 0.903495, 0.905843, 0.908171, 0.910480, 0.912769, 0.915038, 0.917287, 0.919515, 0.921724, 0.923912, 0.926079, 0.928225, 0.930350, 0.932454, 0.934536, 0.936597, 0.938636, 0.940653, 0.942647, 0.944619, 0.946568, 0.948494, 0.950397, 0.952276, 0.954131, 0.955962, 0.957769, 0.959550, 0.961306, 0.963037, 0.964741, 0.966419, 0.968070, 0.969694, 0.971290, 0.972857, 0.974396, 0.975905, 0.977384, 0.978831, 0.980248, 0.981632, 0.982983, 0.984299, 0.985581, 0.986826, 0.988034, 0.989204, 0.990333, 0.991421, 0.992466, 0.993465, 0.994416, 0.995317, 0.996164, 0.996953, 0.997680, 0.998339, 0.998920, 0.999412, 0.999792, 1.000000};
    static const float vrms60HzLUT[] PROGMEM = {0.000000, 0.020406, 0.034299, 0.046461, 0.057615, 0.068071, 0.077999, 0.087506, 0.096666, 0.105530, 0.114138, 0.122522, 0.130705, 0.138707, 0.146546, 0.154234, 0.161784, 0.169206, 0.176508, 0.183699, 0.190786, 0.197773, 0.204668, 0.211474, 0.218197, 0.224839, 0.231405, 0.237899, 0.244322, 0.250678, 0.256970, 0.263200, 0.269370, 0.275482, 0.281538, 0.287540, 0.293489, 0.299388, 0.305238, 0.311039, 0.316794, 0.322503, 0.328169, 0.333791, 0.339371, 0.344910, 0.350408, 0.355868, 0.361289, 0.366673, 0.372020, 0.377331, 0.382606, 0.387847, 0.393054, 0.398227, 0.403368, 0.408477, 0.413553, 0.418599, 0.423614, 0.428599, 0.433554, 0.438480, 0.443377, 0.448245, 0.453086, 0.457899, 0.462685, 0.467443, 0.472176, 0.476882, 0.481562, 0.486217, 0.490846, 0.495450, 0.500030, 0.504585, 0.509116, 0.513623, 0.518107, 0.522567, 0.527004, 0.531417, 0.535809, 0.540177, 0.544524, 0.548848, 0.553150, 0.557430, 0.561689, 0.565927, 0.570143, 0.574338, 0.578512, 0.582666, 0.586799, 0.590911, 0.595003, 0.599075, 0.603127, 0.607159, 0.611171, 0.615164, 0.619137, 0.623090, 0.627024, 0.630939, 0.634835, 0.638712, 0.642570, 0.646409, 0.650229, 0.654031, 0.657814, 0.661579, 0.665325, 0.669053, 0.672763, 0.676454, 0.680128, 0.683783, 0.687420, 0.691040, 0.694641, 0.698225, 0.701791, 0.705339, 0.708870, 0.712383, 0.715878, 0.719356, 0.722817, 0.726260, 0.729686, 0.733094, 0.736485, 0.739858, 0.743215, 0.746554, 0.749876, 0.753180, 0.756468, 0.759738, 0.762991, 0.766227, 0.769446, 0.772648, 0.775832, 0.779000, 0.782150, 0.785283, 0.788400, 0.791499, 0.794581, 0.797645, 0.800693, 0.803723, 0.806737, 0.809733, 0.812712, 0.815674, 0.818618, 0.821546, 0.824456, 0.827348, 0.830224, 0.833082, 0.835922, 0.838746, 0.841551, 0.844339, 0.847110, 0.849863, 0.852598, 0.855316, 0.858016, 0.860698, 0.863362, 0.866008, 0.868636, 0.871246, 0.873838, 0.876412, 0.878967, 0.881504, 0.884023, 0.886523, 0.889004, 0.891467, 0.893911, 0.896335, 0.898741, 0.901128, 0.903495, 0.905843, 0.908171, 0.910480, 0.912769, 0.915038, 0.917287, 0.919515, 0.921724, 0.923912, 0.926079, 0.928225, 0.930350, 0.932454, 0.934536, 0.936597, 0.938636, 0.940653, 0.942647, 0.944619, 0.946568, 0.948494, 0.950397, 0.952276, 0.954131, 0.955962, 0.957769, 0.959550, 0.961306, 0.963037, 0.964741, 0.966419, 0.968070, 0.969694, 0.971290, 0.972857, 0.974396, 0.975905, 0.977384, 0.978831, 0.980248, 0.981632, 0.982983, 0.984299, 0.985581, 0.986826, 0.988034, 0.989204, 0.990333, 0.991421, 0.992466, 0.993465, 0.994416, 0.995317, 0.996164, 0.996953, 0.997680, 0.998339, 0.998920, 0.999412, 0.999792, 1.000000};
  } // namespace DimmerInternal
} // namespace Mycila

uint16_t Mycila::Dimmer::_lookupFiringDelay(uint8_t level, float frequency) {
  if (level == 0)
    return 500000 / frequency; // semi-period in microseconds

  if (level == MYCILA_DIMMER_MAX_LEVEL)
    return 0;

  return frequency == 60 ? (uint16_t)pgm_read_word(&Mycila::DimmerInternal::delay60HzLUT[level]) : (uint16_t)pgm_read_word(&Mycila::DimmerInternal::delay50HzLUT[level]);
}

float Mycila::Dimmer::_lookupVrmsFactor(uint8_t level, float frequency) {
  if (level == 0)
    return 0;

  if (level == MYCILA_DIMMER_MAX_LEVEL)
    return 1;

  return frequency == 60 ? static_cast<float>(pgm_read_float(&Mycila::DimmerInternal::vrms60HzLUT[level])) : static_cast<float>(pgm_read_float(&Mycila::DimmerInternal::vrms50HzLUT[level]));
}
