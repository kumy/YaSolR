<!DOCTYPE html>
<html>

<head>
  <title>YaSolR Configuration</title>
</head>

<body>
  <img src="/logo">
  <h1>YaSolR Configuration</h1>
  <table border="1" cellpadding="5px">
    <tr>
      <td>
        <form id="restart-form">
          <button type="submit">Restart</button>
        </form>
      </td>
    </tr>
    <tr>
      <td>
        <form id="backup-form" method="get" action="/api/config/backup" target="_blank">
          <button type="submit">Backup</button>
        </form>
      </td>
    </tr>
    <tr>
      <td>
        <form id="restore-form">
          <input id="restore-form-file" type="file" accept=".txt" />
          <button type="submit">Restore</button>
        </form>
      </td>
    </tr>
    <tr>
      <td>
        <form id="reset-form">
          <button type="submit">Reset</button>
        </form>
      </td>
    </tr>
  </table>

  <table id="config-table" border="1" cellpadding="5px">
    <tr>
      <th>Name</th>
      <th>Value</th>
      <th>Description</th>
    </tr>
  </table>
</body>

<style>
  table#config-table td:nth-child(2) {
    text-align: center;
  }

  table#config-table th:nth-child(2) {
    text-align: center;
  }
</style>

<script>
  const supportedConfig = {
    Pinout: "TITLE",
    pin_disp_scl: ["Display SCL (CLOCK)", "pin"],
    pin_disp_sda: ["Display SDA (DATA)", "pin"],
    pin_ds18: ["DS18 of router", "pin"],
    pin_jsy_rx: ["Serial RX connected to JSY TX", "pin"],
    pin_jsy_tx: ["Serial TX connected to JSY RX", "pin"],
    pin_lights_g: ["LED Green", "pin"],
    pin_lights_r: ["LED Red", "pin"],
    pin_lights_y: ["LED Yellow", "pin"],
    pin_o1_dim: ["Output 1 Dimmer", "pin"],
    pin_o1_ds18: ["Output 1 DS18", "pin"],
    pin_o1_relay: ["Output 1 Bypass Relay", "pin"],
    pin_o2_dim: ["Dimmer", "pin"],
    pin_o2_ds18: ["Output 2 DS18", "pin"],
    pin_o2_relay: ["Output 2 Bypass Relay", "pin"],
    pin_pzem_rx: ["Serial RX connected to PZEM TX", "pin"],
    pin_pzem_tx: ["Serial TX connected to PZEM RX", "pin"],
    pin_relay1: ["Relay 1", "pin"],
    pin_relay2: ["Relay 2", "pin"],
    pin_zcd: ["Zero-Cross Detection", "pin"],

    "Enable / Disable": "TITLE",
    ap_mode_enable: ["Enable Access Point Mode", "switch"],
    debug_enable: ["Enable Debug Logging", "switch"],
    disp_enable: ["Enable Display (display is connected)", "switch"],
    ds18_sys_enable: ["Enable DS18 for Router (DS18 sensor is connected)", "switch"],
    ha_disco_enable: ["Enable Home Assistant Integration", "switch"],
    jsy_enable: ["Enable JSY (JSY board is connected)", "switch"],
    lights_enable: ["Enable LEDs (Traffic Light LEDs are connected)", "switch"],
    mqtt_enable: ["Enable MQTT", "switch"],
    o1_ab_enable: ["Enable Output 1 automatic bypass based on temperature, days and hours", "switch"],
    o1_ad_enable: ["Enable Output 1 automatic routing based on grid power", "switch"],
    o1_ds18_enable: ["Enable Output 1 temperature (DS18 sensor is connected)", "switch"],
    o1_enable: ["Enable Output 1 (dimmer is connected)", "switch"],
    o1_pzem_enable: ["Enable Output 1 PZEM (PZEM is connected)", "switch"],
    o1_relay_enable: ["Enable Output 1 Bypass Relay (relay is connected)", "switch"],
    o2_ab_enable: ["Enable Output 2 automatic bypass based on temperature, days and hours", "switch"],
    o2_ad_enable: ["Enable Output 2 automatic routing based on grid power", "switch"],
    o2_ds18_enable: ["Enable Output 2 temperature (DS18 sensor is connected)", "switch"],
    o2_enable: ["Enable Output 2 (dimmer is connected)", "switch"],
    o2_pzem_enable: ["Enable Output 2 PZEM (PZEM is connected)", "switch"],
    o2_relay_enable: ["Enable Output 2 Bypass Relay (relay is connected)", "switch"],
    relay1_enable: ["Enable Relay 1", "switch"],
    relay2_enable: ["Enable Relay 2", "switch"],
    zcd_enable: ["Enable Zero-Cross Detection", "switch"],

    Display: "TITLE",
    disp_type: ["Display type", "select", "SH1106,SH1107,SSD1306"],
    disp_angle: ["Display rotation", "select", "0,90,180,270"],

    Electricity: "TITLE",
    grid_freq: ["Grid frequency", "select", "50,60"],
    grid_pow_mqtt: ["Grid power read from MQTT topic", "string"],
    grid_volt: ["Grid voltage", "select", "230,110"],
    grid_volt_mqtt: ["Grid voltage read MQTT topic", "string"],

    MQTT: "TITLE",
    mqtt_secure: ["MQTT secure connection ?", "switch"],
    mqtt_server: ["MQTT server address", "string"],
    mqtt_port: ["MQTT server port", "uint"],
    mqtt_user: ["MQTT username", "string"],
    mqtt_pwd: ["MQTT password", "string"],
    mqtt_topic: ["MQTT topic", "string"],
    mqtt_pub_itvl: ["MQTT publish interval (in seconds)", "uint"],
    ha_disco_topic: ["Home Assistant Discovery topic", "string"],

    Network: "TITLE",
    admin_pwd: ["Admin password", "password"],
    wifi_ssid: ["WiFi SSID", "string"],
    wifi_pwd: ["WiFi password", "password"],
    ntp_server: ["NTP server address", "string"],
    ntp_timezone: ["NTP timezone", "tz"],

    "Output 1": "TITLE",
    o1_dim_limit: ["Output 1 dimmer limiter (limit dimmer level)", "percent"],
    o1_relay_type: ["Output 1 bypass relay type", "select", "NO,NC"],
    o1_days: ["Output 1 auto bypass weekdays", "string"],
    o1_time_start: ["Output 1 auto bypass start time", "time"],
    o1_time_stop: ["Output 1 auto bypass stop time", "time"],
    o1_temp_start: ["Output 1 auto bypass start temperature", "uint"],
    o1_temp_stop: ["Output 1 auto bypass stop temperature", "uint"],

    "Output 2": "TITLE",
    o2_dim_limit: ["Output 2 dimmer limiter (limit dimmer level)", "percent"],
    o2_relay_type: ["Output 2 bypass relay type", "select", "NO,NC"],
    o2_days: ["Output 2 auto bypass weekdays", "string"],
    o2_time_start: ["Output 2 auto bypass start time", "time"],
    o2_time_stop: ["Output 2 auto bypass stop time", "time"],
    o2_temp_start: ["Output 2 auto bypass start temperature", "uint"],
    o2_temp_stop: ["Output 2 auto bypass stop temperature", "uint"],

    "Relay 1": "TITLE",
    relay1_type: ["Relay 1 type", "select", "NO,NC"],
    relay1_load: ["Load in Watts connected to Relay 1 (to activate automatic relay switching)", "uint"],

    "Relay 2": "TITLE",
    relay2_type: ["Relay 2 type", "select", "NO,NC"],
    relay2_load: ["Load in Watts connected to Relay 2 (to activate automatic relay switching)", "uint"],
  };

  async function onInputChange(event) {
    console.log(event);
    const key = event.target.getAttribute("id");
    const formData = new FormData();
    formData.append(key, event.target.type === "checkbox" ? event.target.checked : event.target.value);
    await fetch("/api/config", {
      method: "POST",
      body: formData,
    });
  }

  function addInputNumber(cell, key, value, min, max) {
    const input = document.createElement("input");
    input.setAttribute("id", key);
    input.setAttribute("type", "number");
    input.setAttribute("autocomplete", "off");
    input.setAttribute("min", "" + min);
    input.setAttribute("max", "" + max);
    input.setAttribute("step", "1");
    input.setAttribute("value", value);
    cell.appendChild(input);
    input.addEventListener("change", onInputChange);
  }

  const typeHandlers = {
    switch: function (cell, key, value, options) {
      const input = document.createElement("input");
      input.setAttribute("id", key);
      input.setAttribute("type", "checkbox");
      if (value === "true") {
        input.setAttribute("checked", "checked");
      }
      cell.appendChild(input);
      input.addEventListener("change", onInputChange);
    },
    pin: function (cell, key, value, options) {
      addInputNumber(cell, key, value, 0, 255);
    },
    uint: function (cell, key, value, options) {
      addInputNumber(cell, key, value, 0, 9999);
    },
    percent: function (cell, key, value, options) {
      addInputNumber(cell, key, value, 0, 100);
    },
    string: function (cell, key, value, options) {
      const input = document.createElement("input");
      input.setAttribute("id", key);
      input.setAttribute("type", "text");
      input.setAttribute("autocomplete", "off");
      input.setAttribute("value", value);
      cell.appendChild(input);
      input.addEventListener("change", onInputChange);
    },
    password: function (cell, key, value, options) {
      const input = document.createElement("input");
      input.setAttribute("id", key);
      input.setAttribute("type", "password");
      input.setAttribute("autocomplete", "off");
      input.setAttribute("value", value);
      cell.appendChild(input);
      input.addEventListener("change", onInputChange);
    },
    time: function (cell, key, value, options) {
      const input = document.createElement("input");
      input.setAttribute("id", key);
      input.setAttribute("type", "time");
      input.setAttribute("autocomplete", "off");
      input.setAttribute("value", value);
      cell.appendChild(input);
      input.addEventListener("change", onInputChange);
    },
    tz: function (cell, key, value, options, timezones) {
      const select = document.createElement("select");
      select.setAttribute("id", key);
      timezones.forEach((t) => {
        const option = document.createElement("option");
        option.setAttribute("value", t);
        option.innerHTML = t;
        if (t === value)
          option.setAttribute("selected", "selected");
        select.appendChild(option);
      });
      cell.appendChild(select);
      select.addEventListener("change", onInputChange);
    },
    select: function (cell, key, value, options) {
      const select = document.createElement("select");
      select.setAttribute("id", key);
      options.split(',').map((v) => {
        const option = document.createElement("option");
        option.setAttribute("value", v);
        option.innerHTML = v;
        if (v === value)
          option.setAttribute("selected", "selected");
        select.appendChild(option);
      });
      cell.appendChild(select);
      select.addEventListener("change", onInputChange);
    },
  };

  async function init() {
    document
      .getElementById("restore-form")
      .addEventListener("submit", function (event) {
        event.preventDefault();
        const input = document.getElementById("restore-form-file");
        if (input.files && input.files.length == 1) {
          const formData = new FormData();
          formData.append("file", input.files[0]);
          fetch("/api/config/restore", {
            method: "POST",
            body: formData,
          }).then((res) => {
            setTimeout(function () {
              window.location.reload();
            }, 2000);
          });
        }
      });

    document
      .getElementById("restart-form")
      .addEventListener("submit", function (event) {
        event.preventDefault();
        fetch("/api/system/restart", { method: "POST" }).then((res) => {
          setTimeout(function () {
            window.location.reload();
          }, 2000);
        });
      });

    document
      .getElementById("reset-form")
      .addEventListener("submit", function (event) {
        event.preventDefault();
        fetch("/api/system/reset", { method: "POST" }).then((res) => {
          setTimeout(function () {
            window.location.reload();
          }, 2000);
        });
      });

    Promise.all(
      ["/api/config", "/timezones"].map((u) =>
        fetch(u).then((resp) => resp.json())
      )
    )
      .then((json) => {
        console.log(json);
        const config = json[0];
        const timezones = json[1];
        const table = document.getElementById("config-table");
        for (const k in config) {
          if (supportedConfig[k] == undefined) {
            console.error("Unsupported config key", k);
          }
        }
        for (const k in supportedConfig) {
          const row = table.insertRow(-1);
          if (supportedConfig[k] === "TITLE") {
            const cell = row.insertCell(0);
            cell.innerHTML = "<strong>" + k + "</strong>";
            cell.setAttribute("colspan", "3");
          } else {
            row.insertCell(0).innerHTML = k;
            if (config[k] == undefined) {
              row.insertCell(1).innerHTML = "<strong>DEPRECATED</strong>";
            } else if (typeHandlers[supportedConfig[k][1]]) {
              typeHandlers[supportedConfig[k][1]](
                row.insertCell(1),
                k,
                config[k],
                supportedConfig[k][2],
                timezones
              );
            } else {
              row.insertCell(1).innerHTML = config[k];
            }
            row.insertCell(2).innerHTML = supportedConfig[k][0];
          }
        }
      })
      .catch((error) => {
        console.log(error);
      });
  }

  window.addEventListener("DOMContentLoaded", init, false);
</script>

</html>